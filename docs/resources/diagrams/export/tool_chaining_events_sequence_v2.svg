<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" data-diagram-type="SEQUENCE" height="1730px" preserveAspectRatio="none" style="width:2919px;height:1730px;background:#FFFFFF;" version="1.1" viewBox="0 0 2919 1730" width="2919px" zoomAndPan="magnify"><defs/><g><rect fill="none" height="75.3984" style="stroke:#000000;stroke-width:1.5;" width="1109.8281" x="930.7646" y="227.8281"/><rect fill="none" height="465.3906" style="stroke:#000000;stroke-width:1.5;" width="1767.4541" x="930.7646" y="317.2266"/><rect fill="none" height="371.0625" style="stroke:#000000;stroke-width:1.5;" width="2315.0596" x="345.2598" y="854.8828"/><rect fill="none" height="244.2656" style="stroke:#000000;stroke-width:1.5;" width="2295.0596" x="355.2598" y="974.6797"/><rect fill="none" height="392.3906" style="stroke:#000000;stroke-width:1.5;" width="2558.2017" x="355.2598" y="1239.9453"/><rect fill="none" height="222.4609" style="stroke:#000000;stroke-width:1.5;" width="1601.0186" x="930.7646" y="1402.875"/><g><title>User</title><rect fill="#000000" fill-opacity="0.00000" height="1568.0391" width="8" x="19.9551" y="81.2969"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="23" x2="23" y1="81.2969" y2="1649.3359"/></g><g><title>ChatSession</title><rect fill="#000000" fill-opacity="0.00000" height="1568.0391" width="8" x="150.2847" y="81.2969"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="154.2183" x2="154.2183" y1="81.2969" y2="1649.3359"/></g><g><title>OllamaProvider</title><rect fill="#000000" fill-opacity="0.00000" height="1568.0391" width="8" x="422.1543" y="81.2969"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="425.2598" x2="425.2598" y1="81.2969" y2="1649.3359"/></g><g><title>StreamPublisher</title><rect fill="#000000" fill-opacity="0.00000" height="1568.0391" width="8" x="1001.5044" y="81.2969"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="1004.7646" x2="1004.7646" y1="81.2969" y2="1649.3359"/></g><g><title>MCPToolCallSubscriber</title><rect fill="#000000" fill-opacity="0.00000" height="1568.0391" width="8" x="1390.6533" y="81.2969"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="1394.3823" x2="1394.3823" y1="81.2969" y2="1649.3359"/></g><g><title>MCPToolExecution</title><rect fill="#000000" fill-opacity="0.00000" height="1568.0391" width="8" x="1680.3574" y="81.2969"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="1683.8569" x2="1683.8569" y1="81.2969" y2="1649.3359"/></g><g><title>ToolChainingSubscriber</title><rect fill="#000000" fill-opacity="0.00000" height="1568.0391" width="8" x="1936.7173" y="81.2969"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="1939.8418" x2="1939.8418" y1="81.2969" y2="1649.3359"/></g><g><title>ToolResultCollectorSubscriber</title><rect fill="#000000" fill-opacity="0.00000" height="1568.0391" width="8" x="2287.1812" y="81.2969"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="2291.0615" x2="2291.0615" y1="81.2969" y2="1649.3359"/></g><g class="participant participant-head" data-participant="User"><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="31.9102" x="5" y="77.9951">User</text><ellipse cx="23.9551" cy="13.5" fill="#E2E2F0" rx="8" ry="8" style="stroke:#181818;stroke-width:0.5;"/><path d="M23.9551,21.5 L23.9551,48.5 M10.9551,29.5 L36.9551,29.5 M23.9551,48.5 L10.9551,63.5 M23.9551,48.5 L36.9551,63.5" fill="none" style="stroke:#181818;stroke-width:0.5;"/></g><g class="participant participant-tail" data-participant="User"><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="31.9102" x="5" y="1661.3311">User</text><ellipse cx="23.9551" cy="1673.1328" fill="#E2E2F0" rx="8" ry="8" style="stroke:#181818;stroke-width:0.5;"/><path d="M23.9551,1681.1328 L23.9551,1708.1328 M10.9551,1689.1328 L36.9551,1689.1328 M23.9551,1708.1328 L10.9551,1723.1328 M23.9551,1708.1328 L36.9551,1723.1328" fill="none" style="stroke:#181818;stroke-width:0.5;"/></g><g class="participant participant-head" data-participant="ChatSession"><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="100.1328" x="104.2183" y="50"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="86.1328" x="111.2183" y="69.9951">ChatSession</text></g><g class="participant participant-tail" data-participant="ChatSession"><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="100.1328" x="104.2183" y="1648.3359"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="86.1328" x="111.2183" y="1668.3311">ChatSession</text></g><g class="participant participant-head" data-participant="OllamaProvider"><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="121.7891" x="365.2598" y="50"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="107.7891" x="372.2598" y="69.9951">OllamaProvider</text></g><g class="participant participant-tail" data-participant="OllamaProvider"><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="121.7891" x="365.2598" y="1648.3359"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="107.7891" x="372.2598" y="1668.3311">OllamaProvider</text></g><g class="participant participant-head" data-participant="StreamPublisher"><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="129.4795" x="940.7646" y="50"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="115.4795" x="947.7646" y="69.9951">StreamPublisher</text></g><g class="participant participant-tail" data-participant="StreamPublisher"><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="129.4795" x="940.7646" y="1648.3359"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="115.4795" x="947.7646" y="1668.3311">StreamPublisher</text></g><g class="participant participant-head" data-participant="MCPToolCallSubscriber"><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="174.542" x="1307.3823" y="50"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="160.542" x="1314.3823" y="69.9951">MCPToolCallSubscriber</text></g><g class="participant participant-tail" data-participant="MCPToolCallSubscriber"><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="174.542" x="1307.3823" y="1648.3359"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="160.542" x="1314.3823" y="1668.3311">MCPToolCallSubscriber</text></g><g class="participant participant-head" data-participant="MCPToolExecution"><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="143.001" x="1612.8569" y="50"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="129.001" x="1619.8569" y="69.9951">MCPToolExecution</text></g><g class="participant participant-tail" data-participant="MCPToolExecution"><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="143.001" x="1612.8569" y="1648.3359"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="129.001" x="1619.8569" y="1668.3311">MCPToolExecution</text></g><g class="participant participant-head" data-participant="ToolChainingSubscriber"><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="179.751" x="1850.8418" y="50"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="165.751" x="1857.8418" y="69.9951">ToolChainingSubscriber</text></g><g class="participant participant-tail" data-participant="ToolChainingSubscriber"><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="179.751" x="1850.8418" y="1648.3359"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="165.751" x="1857.8418" y="1668.3311">ToolChainingSubscriber</text></g><g class="participant participant-head" data-participant="ToolResultCollectorSubscriber"><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="224.2393" x="2179.0615" y="50"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="210.2393" x="2186.0615" y="69.9951">ToolResultCollectorSubscriber</text></g><g class="participant participant-tail" data-participant="ToolResultCollectorSubscriber"><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="224.2393" x="2179.0615" y="1648.3359"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="210.2393" x="2186.0615" y="1668.3311">ToolResultCollectorSubscriber</text></g><g class="message" data-participant-1="User" data-participant-2="ChatSession"><polygon fill="#181818" points="142.2847,108.4297,152.2847,112.4297,142.2847,116.4297,146.2847,112.4297" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;" x1="23.9551" x2="148.2847" y1="112.4297" y2="112.4297"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="106.3296" x="30.9551" y="107.3638">send_message()</text></g><g class="message" data-participant-1="ChatSession" data-participant-2="OllamaProvider"><polygon fill="#181818" points="414.1543,137.5625,424.1543,141.5625,414.1543,145.5625,418.1543,141.5625" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;" x1="154.2847" x2="420.1543" y1="141.5625" y2="141.5625"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="247.8696" x="161.2847" y="136.4966">await stream_chat_response(payload)</text></g><g class="message" data-participant-1="OllamaProvider" data-participant-2="OllamaProvider"><line style="stroke:#181818;stroke-width:1;" x1="426.1543" x2="468.1543" y1="170.6953" y2="170.6953"/><line style="stroke:#181818;stroke-width:1;" x1="468.1543" x2="468.1543" y1="170.6953" y2="183.6953"/><line style="stroke:#181818;stroke-width:1;" x1="427.1543" x2="468.1543" y1="183.6953" y2="183.6953"/><polygon fill="#181818" points="437.1543,179.6953,427.1543,183.6953,437.1543,187.6953,433.1543,183.6953" style="stroke:#181818;stroke-width:1;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="222.7012" x="433.1543" y="165.6294">_parse_and_publish_chunk(chunk)</text></g><g class="message" data-participant-1="OllamaProvider" data-participant-2="StreamPublisher"><polygon fill="#181818" points="993.5044,208.8281,1003.5044,212.8281,993.5044,216.8281,997.5044,212.8281" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;" x1="426.1543" x2="999.5044" y1="212.8281" y2="212.8281"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="555.3501" x="433.1543" y="207.7622">publish(StreamEventType.CONTENT/ROLE/LLM_TOOL_CALL_REQUEST/FINISH/USAGE)</text></g><path d="M930.7646,227.8281 L1138.1504,227.8281 L1138.1504,234.9609 L1128.1504,244.9609 L930.7646,244.9609 L930.7646,227.8281" fill="#EEEEEE" style="stroke:#000000;stroke-width:1.5;"/><rect fill="none" height="75.3984" style="stroke:#000000;stroke-width:1.5;" width="1109.8281" x="930.7646" y="227.8281"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="162.3857" x="945.7646" y="240.895">LLM streaming events</text><g class="message" data-participant-1="StreamPublisher" data-participant-2="MCPToolCallSubscriber"><polygon fill="#181818" points="1382.6533,262.0938,1392.6533,266.0938,1382.6533,270.0938,1386.6533,266.0938" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;" x1="1005.5044" x2="1388.6533" y1="266.0938" y2="266.0938"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="365.1489" x="1012.5044" y="261.0278">on_event(StreamEventType.LLM_TOOL_CALL_REQUEST)</text></g><g class="message" data-participant-1="StreamPublisher" data-participant-2="ToolChainingSubscriber"><polygon fill="#181818" points="1928.7173,291.2266,1938.7173,295.2266,1928.7173,299.2266,1932.7173,295.2266" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;" x1="1005.5044" x2="1934.7173" y1="295.2266" y2="295.2266"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="365.1489" x="1012.5044" y="290.1606">on_event(StreamEventType.LLM_TOOL_CALL_REQUEST)</text></g><path d="M930.7646,317.2266 L1090.981,317.2266 L1090.981,324.3594 L1080.981,334.3594 L930.7646,334.3594 L930.7646,317.2266" fill="#EEEEEE" style="stroke:#000000;stroke-width:1.5;"/><rect fill="none" height="465.3906" style="stroke:#000000;stroke-width:1.5;" width="1767.4541" x="930.7646" y="317.2266"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="115.2163" x="945.7646" y="330.2935">Tool call &amp; exec</text><g class="message" data-participant-1="MCPToolCallSubscriber" data-participant-2="MCPToolCallSubscriber"><line style="stroke:#181818;stroke-width:1;" x1="1394.6533" x2="1436.6533" y1="370.625" y2="370.625"/><line style="stroke:#181818;stroke-width:1;" x1="1436.6533" x2="1436.6533" y1="370.625" y2="383.625"/><line style="stroke:#181818;stroke-width:1;" x1="1395.6533" x2="1436.6533" y1="383.625" y2="383.625"/><polygon fill="#181818" points="1405.6533,379.625,1395.6533,383.625,1405.6533,387.625,1401.6533,383.625" style="stroke:#181818;stroke-width:1;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="275.7041" x="1401.6533" y="350.4263">if event.request_id in _recent_request_ids:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="128.6733" x="1409.918" y="365.5591">skip (deduplication)</text></g><g class="message" data-participant-1="MCPToolCallSubscriber" data-participant-2="MCPToolCallSubscriber"><line style="stroke:#181818;stroke-width:1;" x1="1394.6533" x2="1436.6533" y1="412.7578" y2="412.7578"/><line style="stroke:#181818;stroke-width:1;" x1="1436.6533" x2="1436.6533" y1="412.7578" y2="425.7578"/><line style="stroke:#181818;stroke-width:1;" x1="1395.6533" x2="1436.6533" y1="425.7578" y2="425.7578"/><polygon fill="#181818" points="1405.6533,421.7578,1395.6533,425.7578,1405.6533,429.7578,1401.6533,425.7578" style="stroke:#181818;stroke-width:1;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="143.457" x="1401.6533" y="407.6919">parse_tool_call(event)</text></g><g class="message" data-participant-1="MCPToolCallSubscriber" data-participant-2="MCPToolExecution"><polygon fill="#181818" points="1672.3574,450.8906,1682.3574,454.8906,1672.3574,458.8906,1676.3574,454.8906" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;" x1="1394.6533" x2="1678.3574" y1="454.8906" y2="454.8906"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="234.3237" x="1401.6533" y="449.8247">execute_tool_sync(parsed_tool_call)</text></g><g class="message" data-participant-1="MCPToolExecution" data-participant-2="StreamPublisher"><polygon fill="#181818" points="1016.5044,480.0234,1006.5044,484.0234,1016.5044,488.0234,1012.5044,484.0234" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;" x1="1010.5044" x2="1683.3574" y1="484.0234" y2="484.0234"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="377.2856" x="1022.5044" y="478.9575">publish(StreamEventType.MCP_TOOL_CALL_DISPATCHED)</text></g><g class="message" data-participant-1="MCPToolExecution" data-participant-2="MCPToolExecution"><line style="stroke:#181818;stroke-width:1;" x1="1684.3574" x2="1726.3574" y1="513.1563" y2="513.1563"/><line style="stroke:#181818;stroke-width:1;" x1="1726.3574" x2="1726.3574" y1="513.1563" y2="526.1563"/><line style="stroke:#181818;stroke-width:1;" x1="1685.3574" x2="1726.3574" y1="526.1563" y2="526.1563"/><polygon fill="#181818" points="1695.3574,522.1563,1685.3574,526.1563,1695.3574,530.1563,1691.3574,526.1563" style="stroke:#181818;stroke-width:1;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="242.3599" x="1691.3574" y="508.0903">await mcp_manager.execute_tool(...)</text></g><g class="message" data-participant-1="StreamPublisher" data-participant-2="ToolChainingSubscriber"><polygon fill="#181818" points="1928.7173,551.2891,1938.7173,555.2891,1928.7173,559.2891,1932.7173,555.2891" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;" x1="1005.5044" x2="1934.7173" y1="555.2891" y2="555.2891"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="390.0254" x="1012.5044" y="550.2231">on_event(StreamEventType.MCP_TOOL_CALL_DISPATCHED)</text></g><g class="message" data-participant-1="ToolChainingSubscriber" data-participant-2="ToolResultCollectorSubscriber"><polygon fill="#181818" points="2279.1812,590.9883,2289.1812,594.9883,2279.1812,598.9883,2283.1812,594.9883" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;" x1="1940.7173" x2="2285.1812" y1="594.9883" y2="594.9883"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="106.8882" x="1947.7173" y="589.9224">on_event(event)</text></g><path d="M2296,568.2891 L2296,608.2891 L2683,608.2891 L2683,578.2891 L2673,568.2891 L2296,568.2891" fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M2673,568.2891 L2673,578.2891 L2683,578.2891 L2673,568.2891" fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="199.6021" x="2302" y="585.356">ToolResultCollectorSubscriber:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="366.0376" x="2302" y="600.4888">append (tool_call_id, timestamp, call) to tool_call_queue</text><g class="message" data-participant-1="MCPToolExecution" data-participant-2="StreamPublisher"><polygon fill="#181818" points="1016.5044,630.6875,1006.5044,634.6875,1016.5044,638.6875,1012.5044,634.6875" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;" x1="1010.5044" x2="1683.3574" y1="634.6875" y2="634.6875"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="396.9824" x="1022.5044" y="629.6216">publish(MCP_TOOL_CALL_RESULT | MCP_TOOL_CALL_ERROR)</text></g><g class="message" data-participant-1="StreamPublisher" data-participant-2="ToolChainingSubscriber"><polygon fill="#181818" points="1928.7173,659.8203,1938.7173,663.8203,1928.7173,667.8203,1932.7173,663.8203" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;" x1="1005.5044" x2="1934.7173" y1="663.8203" y2="663.8203"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="530.3022" x="1012.5044" y="658.7544">on_event(StreamEventType.MCP_TOOL_CALL_RESULT | MCP_TOOL_CALL_ERROR)</text></g><g class="message" data-participant-1="ToolChainingSubscriber" data-participant-2="ToolResultCollectorSubscriber"><polygon fill="#181818" points="2279.1812,729.7852,2289.1812,733.7852,2279.1812,737.7852,2283.1812,733.7852" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;" x1="1940.7173" x2="2285.1812" y1="733.7852" y2="733.7852"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="106.8882" x="1947.7173" y="728.7192">on_event(event)</text></g><path d="M2296,676.8203 L2296,776.8203 L2551,776.8203 L2551,686.8203 L2541,676.8203 L2296,676.8203" fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M2541,676.8203 L2541,686.8203 L2551,686.8203 L2541,676.8203" fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="199.6021" x="2302" y="693.8872">ToolResultCollectorSubscriber:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="222.3013" x="2302" y="709.02">if tool_call_id in tool_result_buffer:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="108.1323" x="2310.2646" y="724.1528">warn (overwrite)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="234.7363" x="2302" y="739.2856">if tool_call_id not in tool_call_queue:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="154.4702" x="2310.2646" y="754.4185">warn (no matching call)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="159.4531" x="2302" y="769.5513">add to tool_result_buffer</text><g class="message" data-participant-1="StreamPublisher" data-participant-2="ToolChainingSubscriber"><polygon fill="#181818" points="1928.7173,806.75,1938.7173,810.75,1928.7173,814.75,1932.7173,810.75" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;" x1="1005.5044" x2="1934.7173" y1="810.75" y2="810.75"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="233.3398" x="1012.5044" y="805.6841">on_event(StreamEventType.FINISH)</text></g><g class="message" data-participant-1="ToolChainingSubscriber" data-participant-2="ToolResultCollectorSubscriber"><polygon fill="#181818" points="2279.1812,835.8828,2289.1812,839.8828,2279.1812,843.8828,2283.1812,839.8828" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;" x1="1940.7173" x2="2285.1812" y1="839.8828" y2="839.8828"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="106.8882" x="1947.7173" y="834.8169">on_event(event)</text></g><path d="M345.2598,854.8828 L679.1987,854.8828 L679.1987,862.0156 L669.1987,872.0156 L345.2598,872.0156 L345.2598,854.8828" fill="#EEEEEE" style="stroke:#000000;stroke-width:1.5;"/><rect fill="none" height="371.0625" style="stroke:#000000;stroke-width:1.5;" width="2315.0596" x="345.2598" y="854.8828"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="288.939" x="360.2598" y="867.9497">ToolChainingSubscriber event handling</text><g class="message" data-participant-1="ToolChainingSubscriber" data-participant-2="ToolResultCollectorSubscriber"><polygon fill="#181818" points="2279.1812,922.4141,2289.1812,926.4141,2279.1812,930.4141,2283.1812,926.4141" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;" x1="1940.7173" x2="2285.1812" y1="926.4141" y2="926.4141"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="142.4478" x="1947.7173" y="921.3481">get_next_ready_pair()</text></g><path d="M2296,877.0156 L2296,962.0156 L2584,962.0156 L2584,887.0156 L2574,877.0156 L2296,877.0156" fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M2574,877.0156 L2574,887.0156 L2584,887.0156 L2574,877.0156" fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="199.6021" x="2302" y="894.0825">ToolResultCollectorSubscriber:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="143.2856" x="2302" y="909.2153">while tool_call_queue:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="258.8892" x="2310.2646" y="924.3481">if head tool_call_id in tool_result_buffer:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="135.9668" x="2318.5293" y="939.481">pop both, return pair</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="71.9824" x="2310.2646" y="954.6138">else: break</text><path d="M355.2598,974.6797 L419.7026,974.6797 L419.7026,981.8125 L409.7026,991.8125 L355.2598,991.8125 L355.2598,974.6797" fill="#EEEEEE" style="stroke:#000000;stroke-width:1.5;"/><rect fill="none" height="244.2656" style="stroke:#000000;stroke-width:1.5;" width="2295.0596" x="355.2598" y="974.6797"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="19.4429" x="370.2598" y="987.7466">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="126.9458" x="434.7026" y="986.8901">[If ready pair exists]</text><g class="message" data-participant-1="ToolChainingSubscriber" data-participant-2="ToolChainingSubscriber"><line style="stroke:#181818;stroke-width:1;" x1="1940.7173" x2="1982.7173" y1="1062.4102" y2="1062.4102"/><line style="stroke:#181818;stroke-width:1;" x1="1982.7173" x2="1982.7173" y1="1062.4102" y2="1075.4102"/><line style="stroke:#181818;stroke-width:1;" x1="1941.7173" x2="1982.7173" y1="1075.4102" y2="1075.4102"/><polygon fill="#181818" points="1951.7173,1071.4102,1941.7173,1075.4102,1951.7173,1079.4102,1947.7173,1075.4102" style="stroke:#181818;stroke-width:1;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="336.4639" x="1947.7173" y="1057.3442">_chain_continuation_with_lock(tool_call, tool_result)</text></g><path d="M2295.4639,996.8125 L2295.4639,1127.8125 L2634.4639,1127.8125 L2634.4639,1006.8125 L2624.4639,996.8125 L2295.4639,996.8125" fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M2624.4639,996.8125 L2624.4639,1006.8125 L2634.4639,1006.8125 L2624.4639,996.8125" fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="158.2915" x="2301.4639" y="1013.8794">ToolChainingSubscriber:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="219.9717" x="2301.4639" y="1029.0122">current_tool_chain_iteration += 1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="88.6514" x="2301.4639" y="1044.145">if not started:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="95.2085" x="2309.7285" y="1059.2778">started = True</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="132.1836" x="2309.7285" y="1074.4106">tool_chain_id = uuid</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="112.1313" x="2309.7285" y="1089.5435">start_time = now</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="318.1382" x="2301.4639" y="1104.6763">if reached_max_iterations or reached_time_limit:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="173.2466" x="2309.7285" y="1119.8091">is_partial_response = True</text><g class="message" data-participant-1="ToolChainingSubscriber" data-participant-2="OllamaProvider"><polygon fill="#181818" points="437.1543,1150.0078,427.1543,1154.0078,437.1543,1158.0078,433.1543,1154.0078" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;" x1="431.1543" x2="1939.7173" y1="1154.0078" y2="1154.0078"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="350.2256" x="443.1543" y="1148.9419">await stream_chat_response(payload) (next iteration)</text></g><line style="stroke:#000000;stroke-width:1;stroke-dasharray:2.0,2.0;" x1="355.2598" x2="2650.3193" y1="1163.0078" y2="1163.0078"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="94.3218" x="360.2598" y="1173.2183">[No ready pair]</text><g class="message" data-participant-1="ToolChainingSubscriber" data-participant-2="ToolChainingSubscriber"><line style="stroke:#181818;stroke-width:1;" x1="1940.7173" x2="1982.7173" y1="1197.9453" y2="1197.9453"/><line style="stroke:#181818;stroke-width:1;" x1="1982.7173" x2="1982.7173" y1="1197.9453" y2="1210.9453"/><line style="stroke:#181818;stroke-width:1;" x1="1941.7173" x2="1982.7173" y1="1210.9453" y2="1210.9453"/><polygon fill="#181818" points="1951.7173,1206.9453,1941.7173,1210.9453,1951.7173,1214.9453,1947.7173,1210.9453" style="stroke:#181818;stroke-width:1;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="137.5981" x="1947.7173" y="1192.8794">Wait for more results</text></g><path d="M355.2598,1239.9453 L490.4028,1239.9453 L490.4028,1247.0781 L480.4028,1257.0781 L355.2598,1257.0781 L355.2598,1239.9453" fill="#EEEEEE" style="stroke:#000000;stroke-width:1.5;"/><rect fill="none" height="392.3906" style="stroke:#000000;stroke-width:1.5;" width="2558.2017" x="355.2598" y="1239.9453"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="90.1431" x="370.2598" y="1253.0122">Finish event</text><g class="message" data-participant-1="OllamaProvider" data-participant-2="StreamPublisher"><polygon fill="#181818" points="993.5044,1274.2109,1003.5044,1278.2109,993.5044,1282.2109,997.5044,1278.2109" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;" x1="426.1543" x2="999.5044" y1="1278.2109" y2="1278.2109"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="220.6001" x="433.1543" y="1273.145">publish(StreamEventType.FINISH)</text></g><g class="message" data-participant-1="StreamPublisher" data-participant-2="ToolChainingSubscriber"><polygon fill="#181818" points="1928.7173,1303.3438,1938.7173,1307.3438,1928.7173,1311.3438,1932.7173,1307.3438" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;" x1="1005.5044" x2="1934.7173" y1="1307.3438" y2="1307.3438"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="233.3398" x="1012.5044" y="1302.2778">on_event(StreamEventType.FINISH)</text></g><g class="message" data-participant-1="ToolChainingSubscriber" data-participant-2="ToolResultCollectorSubscriber"><polygon fill="#181818" points="2279.1812,1358.1758,2289.1812,1362.1758,2279.1812,1366.1758,2283.1812,1362.1758" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;" x1="1940.7173" x2="2285.1812" y1="1362.1758" y2="1362.1758"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="233.3398" x="1947.7173" y="1357.1099">on_event(StreamEventType.FINISH)</text></g><path d="M2296,1320.3438 L2296,1390.3438 L2898,1390.3438 L2898,1330.3438 L2888,1320.3438 L2296,1320.3438" fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M2888,1320.3438 L2888,1330.3438 L2898,1330.3438 L2888,1320.3438" fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="158.2915" x="2302" y="1337.4106">ToolChainingSubscriber:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="581.2803" x="2302" y="1352.5435">if is_partial_response or (not has_pending_tool_calls and not is_expecting_mcp_tool_call):</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="169.0127" x="2310.2646" y="1367.6763">publish TOOL_CHAIN_END</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="43.3545" x="2310.2646" y="1382.8091">reset()</text><path d="M930.7646,1402.875 L995.2075,1402.875 L995.2075,1410.0078 L985.2075,1420.0078 L930.7646,1420.0078 L930.7646,1402.875" fill="#EEEEEE" style="stroke:#000000;stroke-width:1.5;"/><rect fill="none" height="222.4609" style="stroke:#000000;stroke-width:1.5;" width="1601.0186" x="930.7646" y="1402.875"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="19.4429" x="945.7646" y="1415.9419">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="434.8975" x="1010.2075" y="1415.0854">[ToolChainingSubscriber: is_partial_response or no pending tool calls]</text><g class="message" data-participant-1="ToolChainingSubscriber" data-participant-2="StreamPublisher"><polygon fill="#181818" points="1016.5044,1437.1406,1006.5044,1441.1406,1016.5044,1445.1406,1012.5044,1441.1406" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;" x1="1010.5044" x2="1939.7173" y1="1441.1406" y2="1441.1406"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="295.604" x="1022.5044" y="1436.0747">publish(StreamEventType.TOOL_CHAIN_END)</text></g><g class="message" data-participant-1="ToolChainingSubscriber" data-participant-2="ToolChainingSubscriber"><line style="stroke:#181818;stroke-width:1;" x1="1940.7173" x2="1982.7173" y1="1504.6055" y2="1504.6055"/><line style="stroke:#181818;stroke-width:1;" x1="1982.7173" x2="1982.7173" y1="1504.6055" y2="1517.6055"/><line style="stroke:#181818;stroke-width:1;" x1="1941.7173" x2="1982.7173" y1="1517.6055" y2="1517.6055"/><polygon fill="#181818" points="1951.7173,1513.6055,1941.7173,1517.6055,1951.7173,1521.6055,1947.7173,1517.6055" style="stroke:#181818;stroke-width:1;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="43.3545" x="1947.7173" y="1499.5396">reset()</text></g><path d="M2002.3545,1454.1406 L2002.3545,1554.1406 L2251.3545,1554.1406 L2251.3545,1464.1406 L2241.3545,1454.1406 L2002.3545,1454.1406" fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M2241.3545,1454.1406 L2241.3545,1464.1406 L2251.3545,1464.1406 L2241.3545,1454.1406" fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="158.2915" x="2008.3545" y="1471.2075">ToolChainingSubscriber:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="99.5122" x="2008.3545" y="1486.3403">started = False</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="105.9805" x="2008.3545" y="1501.4731">start_time = 0.0</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="228.6743" x="2008.3545" y="1516.606">is_expecting_mcp_tool_call = False</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="177.5503" x="2008.3545" y="1531.7388">is_partial_response = False</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="209.0791" x="2008.3545" y="1546.8716">current_tool_chain_iteration = 0</text><g class="message" data-participant-1="ToolChainingSubscriber" data-participant-2="ToolResultCollectorSubscriber"><polygon fill="#181818" points="2279.1812,1595.2031,2289.1812,1599.2031,2279.1812,1603.2031,2283.1812,1599.2031" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;" x1="1940.7173" x2="2285.1812" y1="1599.2031" y2="1599.2031"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="43.3545" x="1947.7173" y="1594.1372">reset()</text></g><path d="M2296,1564.9375 L2296,1619.9375 L2516,1619.9375 L2516,1574.9375 L2506,1564.9375 L2296,1564.9375" fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M2506,1564.9375 L2506,1574.9375 L2516,1574.9375 L2506,1564.9375" fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="199.6021" x="2302" y="1582.0044">ToolResultCollectorSubscriber:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="147.0244" x="2302" y="1597.1372">tool_call_queue.clear()</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="160.0117" x="2302" y="1612.27">tool_result_buffer.clear()</text><!--SRC=[nLRVR-8u47xFNp5FfqJRetklbVQaYgPR91QwaEfUJh9COeXLnyxPJccb_UDtx0GIQA1iosbvGE3vFT_d6TFKAWqFXkcWfDhob9TKMXZcrCwPCLp9dVEf4BIWzrezyMpFP6ureyLzjH3Sv7koRyFxH2anf4BCguL9DL_qQyJFBAtiVbHlcrCkkLmTi7SgCsOgOOTA2EQgwcW6ha3uy-zkNN05XicC5FYNhbWO1LqXwkxMYkfqJRa5u-iaAIeJpKoff65XIL-4ebaKx1drkI6Ojs64OkooxXOwg-HZwB_xNEor5dqqXc4jYP-OjCbBoGR3wII99ydbR3gEByVZRoIPJiTaU3qUardy_I6U9vUteybeVdVvCB_-6aT1iDAgAW5LcyAmnS2SFnC0VlP3OpQzO69EIX9l-2gftZoYG-xxmNw7VmHtKvxp2Iac37y0GuhvsFrr72cGB-lE33JxhsB64fu1bu0iIF6KjAVcwby9O1vv2M76igeKFAMErT7x0jU4iIWYheZGPt6Qh-s5GZVC_suScHUPXjvnrdhUyTcQ_X85qRg3nireVd-T3E_YcyE-UrAjhrgHbgIW4c-d7dIJ3mU30LBtR0Gwdl81VqsaWqEd6x03c5IMWUQht5uTjqSEqR944aEunGUvTG6MuyYoj2WlFAKZi0fQ3UHWnO9tuBZRX5ayVnWdy0DsZ-FPR3gB_g_Elntqzs61bxyBWxlu_h_sDcHHBPTU3s1DjOHGFJ6zrjoowBKjnjtQjw1rZAM2WjeqTyFOOunSoB8jq3inwpbt5ZJgrH05v-joP_xsEFHAaECc52Zu8C0hPebapsuEq-m5bopNuQ_3lCwvOBt888WvUZwL1G2bAc6XR7u1cjaAONKfEH4JXbt10lDyzFbHOM6q19-tLy99pKspWDzkIY_6xdt29KcLj5nMVlcGDRSv4IfzR0VAHJVzQ1jmlsElGs2DQQMrstkrCnyEwQvzBFZq1Vxon7TSnscbBSlghLZ_XY-Gw8gvawwzEwygdcqrYPjsU2ZLshl39gKvhgo2FhVH3E0RTYDn1aJmWjiQDaFyEv6AxMkjYNr2Uz_p1CJRYoo4RN9rLntcC54Ta3-2xZykYoKMNIYDG7dqQhguOT1v-DoYhSdhY-Rb7tbSRiR3sQP_r-4PPiunzoSn6ldLHnViS-Xed5CKOdFHh7qo6S3nLKzqGzXpYVavkNkwjCygpyIchL0ljhlhqOJ4anidmKZCDiFA3OC32HvA3hT5avQ_ItvZd38yJaT-D-Ne8zJjrdeoCEtGkALuaPg3pMpuFFYCs1tiVclLFmiQuT5nXa5EBFeOKz-g_TXYsbj9WrGmYWkk4UpidusiEn1-0W00]--></g></svg>